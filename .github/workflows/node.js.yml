# #FRONTEND 
# name: Build React Files & Deploy to Ubuntu server

# on:
#   push:
#     branches: [ master ]
#   pull_request:
#     branches: [ master ]

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v2
#     - name: Use Node.js 20.x to Build
#       uses: actions/setup-node@v2
#       with:
#         node-version: 20.x
#         #cache: 'npm'
#     - run: npm install
#     - run: REACT_APP_STAGE=production
#     - run: CI=false npm run build
#     - name: ssh deploy on server
#       uses: easingthemes/ssh-deploy@v2.1.4
#       with:
#           host: ${{ secrets.HOST }}
#           port: ${{ secrets.PORT }}
#           username: ${{ secrets.USERNAME }}
#           password: ${{ secrets.PASSWORD }}
#           run: |
#             cd /home/ibis/test-deployment
#             git pull origin master
#             npm install
#             npm run build
#             pm2 restart 2


name: Frontend CI/CD pipeline

on:
  push:
    branches: [ master ] # tells github to run this on any push to the repository

jobs:
  test: # names the job
    runs-on: ubuntu-latest # sets the version of linux we want to use, should be what you have on your server

    strategy:
      fail-fast: false # tells github to not run further steps if this one fails
      matrix:
        node-version: [20.x] # sets the version of node we want to use, should be what you have on your server

    steps:
      - uses: actions/checkout@v2 # fetches your commit to test it
      - name: Use Node.js ${{ matrix.node-version }} # names our step
        uses: actions/setup-node@v1 # downloads node and npm
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm install # installs your dependencies
      - run: npm run build # builds your app
      # - run: npm test # runs your test suite
        env:
          CI: true # shows terminal output!

  deploy:
    runs-on: ubuntu-latest
    needs: test # this job depends on "test" having finished
    if: github.ref == 'refs/heads/master' # we tell Github to only execute this step if we're on our master branch (so we don't put unfinished branches in production)
    steps:
      - name: Deploying to Local Server
        uses: appleboy/ssh-action@master # An action made to control Linux servers
        with: # We set all our secrets here for the action, these won't be shown in the action logs
          host: 15.206.7.176
          username: ubuntu
          key: -----BEGIN RSA PRIVATE KEY----- MIIEpAIBAAKCAQEAqpBABKo3G1fqkfk0NGAZbNQypRfui7T1KjEtKlX/YcBIV6xw505vOy9MU8R3C/13j5VH16bgVCDs0gu5I8wW5vFu9afjUNRhuTSflsVnPJ3E/i35Hn2fiT4Ywv28kDJncsq+PC2CDqVtm2EMMBn7NWT1GHlksbP0kM2CM/nv+6rbZKxtSVsMoouXVsZWpRW121hGj/rmEhtymcYI85NTPtR6nav0uXxMpawd6vPQ8isLhifjtDGYbHlPQ3fAtw+DBYwkln4JqjOmoUVzpalPIEX3d/gSRW3WTIZ78qIXltJXb0gxmhCyO+lP2NKfeibEpvOaG5l/9xEj03xUQtGhDQIDAQABAoIBABXSiO5P3OcZs4BjswM0fGxJJgWrbzDewTNZwV6WTCt0j4zwGi3uAhs/bPOWwmh9UIvFXMDBsBfzcnlZWKG03gVERJ8XkOTpl2s7yWNf9Fp0ER04QpRdHElR8ZcZIcQNPuEYAYjvhaFcFw73Nrj8ygBF33n3JiP6U0MnmA4QX10ChMCY+lwYuKFCMarR0Bv2vDSFr8rgmhi3eldj0sRO2+XLH+Jajd10jz8yK8MDbpPp1DAgL/eXdCaNFlqedL5A0H+Lq6KDVpOOfQu7EvdeL0JxDUibU6DBPcJJAwVoQSAgwqhIkHrd7JS1kD+/tI7IOssNIWsWVQ8EpPaJvuo5EGECgYEA0nxwsGkRLA+pxNn4t+w9c2FPLtZf4KlwNjSsND7WIT2mkBEcxxnO+mQ3VugN7C5a7/cp2EWyYjb9e2oRnJFSsSd8MkpcZG1LBEouAkbAMb+OlHlf//zLRaCuD45BZj7QR3RDHXj752LvkJNCkH7dwO42bNuyLsZ4jbtHZca7JHkCgYEAz3HfwAS9Yh29vLf80pm9HNrh2eITxViAJ8Kchy89W2JjckYkYAeXMhVy2vE2/uN9yzP/19drCfByTgrF39vthhwYdYNFTXcg+bZfz1StnyzdnpnS9T8dCeSEdGDbtxo3pn7gDVaW1usbPZkoPqfZ7R7OMtSBELqSyTpZV0RetDUCgYEAg7mo9F3shzyOLEmVI9VOZ8TAPzmd6wVe2i2Aj3m7nDXu5T4wWlHGfGD3WQYEoIgqFP8DSvvjNR/g5rlsqCUyMPfa+8YZqCfVyKt7u6T3ZqrQ2g5Ti+pyc/Kou8d1Gj25Lt6NmgY674W1Ey91euRKdxEdMmcTTb6bd2d6uTDzsVECgYAKrTSz4EqS+y7hwKJtgGYgTw+itCUKWiS2ZyjBOGgzBNxTbFLA8oMQm9P+er223qSBydpYFIk4yLxJUfqfK+WMqnOD0M7HTuNOltlVhWkuMRPy7r3Ry37GHJHIn5ePU/UbR5pmdVdsFkufnvtYRjFMJ/K64P8HimK1oqAogqdRJQKBgQCfsDj+D5rNrtpPaNsg5F3znON0GIq4OXCgd3VRl9Gkv89ZTh6o8H1ga6Yvo/d2CofnwaYTs7xtP/c0rNVK2ZmEhtuifJGj3uk8tnIsX2GfSiICptXsRBrANTl7iEuYK9bejvW7kdS/VxVAzhJXX/B3kil/CWictykWhaIjtjqNOA== -----END RSA PRIVATE KEY-----
          port : 22
          script: |
            # cd /home/ubuntu/test-deployment # we move into our app's folder
            # git pull origin master # we pull any changes from git
            # npm prune # we remove any unused dependencies
            # npm install # we install any missing dependencies
            # npm run build # we build our app
            # pm2 restart 2